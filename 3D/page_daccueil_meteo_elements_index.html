<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Les éléments météorologiques — Accueil</title>

    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        body{
            font-family: Arial, sans-serif;
            background: #f3f6fa;
            margin: 0;
            padding: 0;
            color: #222;
            line-height: 1.6;
        }

        header{
            background: #3a6ea5;
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        /* --- MENU UTILISATEUR --- */
        #user-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            border: 1px solid rgba(255,255,255,0.3);
        }

        #user-menu:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        #user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #ddd;
            border: 2px solid white;
        }

        #user-name {
            font-weight: bold;
            font-size: 0.95rem;
            color: white;
        }

        #google-button-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.01;
            overflow: hidden;
            z-index: 10;
        }

        header h1{ margin: 0; font-size: 2rem; }
        header p{ margin-top: 10px; font-size: 1.1rem; }

        main{
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .intro{
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h2{ color: #3a6ea5; }

        .sections{
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .card{
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: transform .2s;
        }

        /* --- CSS CARROUSEL --- */
        .carousel-container {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding-bottom: 20px;
            scroll-behavior: smooth;
        }

        .carousel-container .card {
            min-width: 250px;
            max-width: 300px;
            flex-shrink: 0;
            border: 2px solid #e63946;
        }

        .carousel-container::-webkit-scrollbar { height: 8px; }
        .carousel-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        .card:hover{ transform: scale(1.02); }

        footer{
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            background: #e7eff7;
            color: #555;
        }
    </style>
</head>
<body>
<header>
    <div id="user-menu">
        <div id="google-button-container"></div>
        <img id="user-avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Avatar" referrerpolicy="no-referrer">
        <span id="user-name">Invité (Connexion)</span>
    </div>
    <h1>Les éléments météorologiques</h1>
    <p>Comprendre les phénomènes qui influencent notre météo quotidienne</p>
</header>

<main>
    <section class="intro">
        <h2>Bienvenue</h2>
        <p>
            Cette page d'accueil introduit les principaux éléments météorologiques : nuages, pluie, vent, température, pression, et autres phénomènes qui façonnent notre climat. Vous y trouverez des explications simples et accessibles destinées à un article ou un dossier éducatif.
        </p>
    </section>

    <section id="favorites-section" style="margin-bottom: 40px;">
        <h2 style="color: #e63946;">❤️ Vos Favoris</h2>

        <p id="not-connected-msg" style="color: red; font-weight: bold; background: #ffe6e6; padding: 10px; border-radius: 5px; text-align: center;">
            Connectez-vous afin d'enregistrer vos favoris
        </p>

        <div id="connected-content" style="display: none;">
            <p>Retrouvez ici vos articles sauvegardés.</p>
            <div id="favorites-container" class="carousel-container">
            </div>
        </div>
    </section>
    <section style="margin-top:20px;">
        <h2>Page 2 — Prévisualisation</h2>
        <iframe src="index.html" width="100%" height="500" style="border:1px solid #ccc; border-radius:10px;"></iframe>
    </section>

    <section class="sections">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Les nuages</h3>
                <span class="heart-icon" onclick="toggleFavorite(this, 'Les nuages')" style="cursor:pointer; font-size:1.5rem; color:#ccc;">♡</span>
            </div>
            <p>Types de nuages, formation, altitude et rôle dans la prédiction du temps.</p>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>La pluie et les précipitations</h3>
                <span class="heart-icon" onclick="toggleFavorite(this, 'La pluie et les précipitations')" style="cursor:pointer; font-size:1.5rem; color:#ccc;">♡</span>
            </div>
            <p>Cycle de l'eau, conditions d'apparition de la pluie, neige, grêle et intensités.</p>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Le vent</h3>
                <span class="heart-icon" onclick="toggleFavorite(this, 'Le vent')" style="cursor:pointer; font-size:1.5rem; color:#ccc;">♡</span>
            </div>
            <p>Origine des vents, courants atmosphériques, vitesse et direction.</p>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>La température</h3>
                <span class="heart-icon" onclick="toggleFavorite(this, 'La température')" style="cursor:pointer; font-size:1.5rem; color:#ccc;">♡</span>
            </div>
            <p>Pourquoi les températures varient, effets du soleil et des masses d'air.</p>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>La pression atmosphérique</h3>
                <span class="heart-icon" onclick="toggleFavorite(this, 'La pression atmosphérique')" style="cursor:pointer; font-size:1.5rem; color:#ccc;">♡</span>
            </div>
            <p>Pression haute et basse, influence sur le temps et les masses d'air.</p>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Les phénomènes extrêmes</h3>
                <span class="heart-icon" onclick="toggleFavorite(this, 'Les phénomènes extrêmes')" style="cursor:pointer; font-size:1.5rem; color:#ccc;">♡</span>
            </div>
            <p>Orages, cyclones, canicules : comment se forment-ils ?</p>
        </div>
    </section>
</main>

<footer>
    © Article — Les éléments météorologiques
</footer>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // --- CONFIGURATION ---
    const GOOGLE_CLIENT_ID = "627927284714-f11a1jfo7h36o57j8rem5ugjpdu1ka3o.apps.googleusercontent.com";
    const SUPABASE_URL = "https://fkneemlnxqbgdyhdtaet.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrbmVlbWxueHFiZ2R5aGR0YWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzMDk3MjcsImV4cCI6MjA4MDg4NTcyN30.EH7qrY4qVT-Tktfzjd3gI1pYIpHi_q9Z_dwATIo_0-0";

    // Initialisation de Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variable globale pour stocker l'email de l'utilisateur connecté
    let currentUserEmail = null;

    // --- FONCTIONS GOOGLE ---

    function decodeJwtResponse(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    async function handleCredentialResponse(response) {
        const data = decodeJwtResponse(response.credential);

        // 1. Mise à jour UI du Header
        document.getElementById("user-name").innerText = data.name;
        document.getElementById("user-avatar").src = data.picture;
        const btnContainer = document.getElementById("google-button-container");
        if(btnContainer) btnContainer.remove();
        document.getElementById("user-menu").style.cursor = "default";

        // 2. Gestion de l'affichage de la section favoris
        // On cache le message rouge
        document.getElementById("not-connected-msg").style.display = "none";
        // On affiche le conteneur du carrousel
        document.getElementById("connected-content").style.display = "block";

        // 3. Sauvegarde de l'email pour Supabase
        currentUserEmail = data.email;
        console.log("Utilisateur connecté : " + currentUserEmail);

        // 4. Charger les favoris depuis la base de données
        await loadFavorites();
    }

    // --- FONCTIONS SUPABASE (Favoris) ---

    async function toggleFavorite(element, cardName) {
        if (!currentUserEmail) {
            alert("Veuillez vous connecter avec Google pour sauvegarder vos favoris !");
            return;
        }

        const isHeartFull = element.innerText.includes("♥");

        if (isHeartFull) {
            // SUPPRESSION
            const { error } = await supabase
                .from('favoris')
                .delete()
                .eq('user_email', currentUserEmail)
                .eq('card_name', cardName);

            if(error) console.error("Erreur suppression", error);

        } else {
            // AJOUT
            const { error } = await supabase
                .from('favoris')
                .insert([{ user_email: currentUserEmail, card_name: cardName }]);

            if(error) console.error("Erreur ajout", error);
        }

        // IMPORTANT : On recharge tout l'affichage (cœurs + carrousel)
        await loadFavorites();
    }

    async function loadFavorites() {
        if (!currentUserEmail) return;

        // 1. On récupère la liste des favoris depuis Supabase
        const { data, error } = await supabase
            .from('favoris')
            .select('card_name')
            .eq('user_email', currentUserEmail);

        if (error) {
            console.error("Erreur chargement", error);
            return;
        }

        // 2. Gestion de l'affichage de la section Carrousel
        const favSection = document.getElementById("favorites-section");
        const favContainer = document.getElementById("favorites-container");

        if(!favSection || !favContainer) return;

        favContainer.innerHTML = "";

        // On remet tous les cœurs à zéro (gris)
        document.querySelectorAll('.heart-icon').forEach(icon => {
            icon.innerText = "♡";
            icon.style.color = "#ccc";
        });

        // Cas particulier : Connecté mais 0 favoris
        if (data.length === 0) {
            // On cache toute la section pour ne pas avoir un titre "Favoris" vide
            favSection.style.display = "none";
            return;
        } else {
            // S'il y a des données, on s'assure que la section est visible
            favSection.style.display = "block";
        }

        data.forEach(favori => {
            const allHearts = document.querySelectorAll('.heart-icon');
            allHearts.forEach(heart => {
                if (heart.getAttribute('onclick').includes(favori.card_name)) {
                    heart.innerText = "♥";
                    heart.style.color = "red";

                    // CLONAGE
                    const originalCard = heart.closest('.card');
                    if (originalCard) {
                        const clone = originalCard.cloneNode(true);
                        favContainer.appendChild(clone);
                    }
                }
            });
        });
    }

    // --- INIT ---
    window.onload = function () {
        google.accounts.id.initialize({
            client_id: GOOGLE_CLIENT_ID,
            callback: handleCredentialResponse
        });

        google.accounts.id.renderButton(
            document.getElementById("google-button-container"),
            { theme: "outline", size: "large", type: "standard" }
        );
    };
</script>
</body>
</html>